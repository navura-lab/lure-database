---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Badge from '../../components/Badge.astro';
import Placeholder from '../../components/Placeholder.astro';

import { fetchAllLures } from '../../lib/fetch-all-lures';
import { groupLuresBySeries } from '../../lib/group-lures';
import type { LureSeries } from '../../lib/types';

export async function getStaticPaths() {
  const lures = await fetchAllLures();

  const allSeries = groupLuresBySeries(lures ?? []);

  return allSeries.map(series => ({
    params: { manufacturer_slug: series.manufacturer_slug, slug: series.slug },
    props: { series },
  }));
}

const { series } = Astro.props as { series: LureSeries };

const hasLimited = series.colors.some(c => c.is_limited);

const hasPrice = series.price_range.max > 0;
const priceDisplay = hasPrice
  ? series.price_range.min === series.price_range.max
    ? `¥${series.price_range.min.toLocaleString()}`
    : `¥${series.price_range.min.toLocaleString()} ~ ¥${series.price_range.max.toLocaleString()}`
  : null;

const weightDisplay = (() => {
  if (!series.weight_range.min) return null;
  if (series.weight_range.min === series.weight_range.max) return `${series.weight_range.min}g`;
  return `${series.weight_range.min} ~ ${series.weight_range.max}g`;
})();

const lengthDisplay = (() => {
  if (!series.length_range.min) return null;
  if (series.length_range.min === series.length_range.max) return `${series.length_range.min}mm`;
  return `${series.length_range.min} ~ ${series.length_range.max}mm`;
})();

function getYouTubeEmbedUrl(url: string): string | null {
  const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/);
  return match ? `https://www.youtube.com/embed/${match[1]}` : null;
}

const embedUrl = series.official_video_url
  ? getYouTubeEmbedUrl(series.official_video_url)
  : null;

// --- SEO: Description ---
const specs = [
  series.type,
  weightDisplay ? `重さ${weightDisplay}` : null,
  lengthDisplay ? `全長${lengthDisplay}` : null,
  `${series.color_count}カラー`,
].filter(Boolean).join('・');
const pageDescription = `${series.manufacturer} ${series.name}（${specs}）のスペック・カラーバリエーション・価格情報。${series.description ? series.description.substring(0, 80) : ''}`;

// --- SEO: JSON-LD Product schema ---
const jsonLd: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: series.name,
  description: series.description || `${series.manufacturer} ${series.name} - ${series.type}`,
  brand: {
    '@type': 'Brand',
    name: series.manufacturer,
  },
  category: series.type,
  url: `https://www.lure-db.com/${series.manufacturer_slug}/${series.slug}/`,
  ...(series.representative_image ? { image: series.representative_image } : {}),
  ...(hasPrice ? {
    offers: {
      '@type': 'AggregateOffer',
      priceCurrency: 'JPY',
      lowPrice: series.price_range.min,
      highPrice: series.price_range.max,
      offerCount: series.color_count,
    },
  } : {}),
  additionalProperty: [
    ...(series.weight_range.min ? [{
      '@type': 'PropertyValue',
      name: '重量',
      value: weightDisplay,
    }] : []),
    ...(series.length_range.min ? [{
      '@type': 'PropertyValue',
      name: '全長',
      value: lengthDisplay,
    }] : []),
    ...(series.diving_depth ? [{
      '@type': 'PropertyValue',
      name: '潜行深度',
      value: series.diving_depth,
    }] : []),
  ],
};

// BreadcrumbList JSON-LD
const breadcrumbLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'トップ',
      item: 'https://www.lure-db.com/',
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: series.manufacturer,
      item: `https://www.lure-db.com/${series.manufacturer_slug}/`,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: series.name,
      item: `https://www.lure-db.com/${series.manufacturer_slug}/${series.slug}/`,
    },
  ],
};

// Combine JSON-LD as array
const combinedJsonLd = [jsonLd, breadcrumbLd] as unknown as Record<string, unknown>;
---

<BaseLayout
  title={`${series.name}（${series.manufacturer}）- ルアーDB`}
  description={pageDescription}
  canonicalPath={`/${series.manufacturer_slug}/${series.slug}/`}
  ogImage={series.representative_image || undefined}
  jsonLd={combinedJsonLd}
>
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- パンくず -->
    <nav class="text-sm text-text-secondary mb-8">
      <a href="/" class="hover:text-primary transition-colors">トップ</a>
      <span class="mx-2">/</span>
      <a href={`/${series.manufacturer_slug}/`} class="hover:text-primary transition-colors">{series.manufacturer}</a>
      <span class="mx-2">/</span>
      <span class="text-gray-900">{series.name}</span>
    </nav>

    <!-- メインエリア -->
    <div class="flex flex-col md:flex-row gap-8 mb-12">
      <!-- 画像 -->
      <div class="md:w-1/2">
        <div class="aspect-square rounded-xl overflow-hidden border border-gray-100 bg-white">
          {series.representative_image ? (
            <img
              src={series.representative_image}
              alt={series.name}
              class="w-full h-full object-scale-down p-6"
            />
          ) : (
            <Placeholder type={series.type} />
          )}
        </div>
      </div>

      <!-- 情報 -->
      <div class="md:w-1/2">
        <p class="text-sm text-text-secondary tracking-wider uppercase mb-1">
          {series.manufacturer}
        </p>
        <h1 class="text-3xl font-bold text-gray-900 mb-3">
          {series.name}
        </h1>

        <div class="flex flex-wrap gap-2 mb-6">
          <Badge label={series.type} variant="type" />
          {hasLimited && <Badge label="限定あり" variant="limited" />}
        </div>

        <!-- スペック -->
        <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm mb-6">
          {weightDisplay && (
            <div>
              <p class="text-text-tertiary">重さ</p>
              <p class="font-medium">{weightDisplay}</p>
            </div>
          )}
          {lengthDisplay && (
            <div>
              <p class="text-text-tertiary">長さ</p>
              <p class="font-medium">{lengthDisplay}</p>
            </div>
          )}
          {series.diving_depth && (
            <div>
              <p class="text-text-tertiary">潜行深度</p>
              <p class="font-medium">{series.diving_depth}</p>
            </div>
          )}
          {series.action_type && (
            <div>
              <p class="text-text-tertiary">アクション</p>
              <p class="font-medium">{series.action_type}</p>
            </div>
          )}
          {series.release_year && (
            <div>
              <p class="text-text-tertiary">発売年</p>
              <p class="font-medium">{series.release_year}年</p>
            </div>
          )}
          <div>
            <p class="text-text-tertiary">カラー数</p>
            <p class="font-medium">{series.color_count}色</p>
          </div>
        </div>

        <!-- 価格 -->
        {priceDisplay && (
          <div class="border-t border-gray-100 pt-4 mb-6">
            <p class="text-text-tertiary text-sm">価格</p>
            <p class="text-2xl font-bold text-gray-900">{priceDisplay}</p>
          </div>
        )}

        <!-- 説明 -->
        {series.description && (
          <p class="text-sm text-text-secondary leading-relaxed">
            {series.description}
          </p>
        )}
      </div>
    </div>

    <!-- カラーバリエーション -->
    <section class="mb-12">
      <div class="flex items-baseline gap-3 mb-6">
        <h2 class="text-xl font-bold text-gray-900">カラーバリエーション</h2>
        <span class="text-sm text-text-secondary">{series.color_count}色</span>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
        {series.colors.map(color => (
          <div class="group">
            <div class="aspect-square rounded-xl overflow-hidden border border-gray-100 bg-white mb-2 transition-all duration-200 group-hover:border-primary group-hover:shadow-card-hover">
              {color.images && color.images.length > 0 ? (
                <img
                  src={color.images[0]}
                  alt={color.color_name}
                  loading="lazy"
                  class="w-full h-full object-scale-down p-3"
                />
              ) : (
                <Placeholder size="sm" />
              )}
            </div>
            <p class="text-sm font-medium text-gray-900 truncate">{color.color_name}</p>
            <!-- ウェイトバッジ横並び -->
            {color.weights.length > 0 && (
              <div class="flex flex-wrap gap-1 mt-1">
                {color.weights.map(w => (
                  <span class="px-2 py-0.5 bg-gray-50 text-xs text-gray-600 rounded-full border border-gray-100">
                    {w.weight && `${w.weight}g`}{w.weight && w.length && ' / '}{w.length && `${w.length}mm`}
                  </span>
                ))}
              </div>
            )}
            <div class="flex items-center gap-2 mt-0.5">
              {color.is_limited && <Badge label="限定" variant="limited" />}
              {color.is_discontinued && <Badge label="廃盤" variant="discontinued" />}
            </div>
            {color.weights.length === 1 && color.weights[0].price > 0 && (
              <p class="text-sm font-bold text-gray-900 mt-1">¥{color.weights[0].price.toLocaleString()}</p>
            )}
          </div>
        ))}
      </div>
    </section>

    <!-- 公式動画 -->
    {embedUrl && (
      <section class="mb-12">
        <h2 class="text-xl font-bold text-gray-900 mb-4">公式動画</h2>
        <div class="aspect-video rounded-xl overflow-hidden border border-gray-100">
          <iframe
            src={embedUrl}
            title={`${series.name} 公式動画`}
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            class="w-full h-full"
          ></iframe>
        </div>
      </section>
    )}

    <!-- 対象魚 -->
    {series.target_fish.length > 0 && (
      <section class="mb-12">
        <h2 class="text-xl font-bold text-gray-900 mb-4">対象魚</h2>
        <div class="flex flex-wrap gap-2">
          {series.target_fish.map(fish => (
            <span class="px-3 py-1.5 bg-gray-50 text-gray-700 rounded-full text-sm border border-gray-100">
              {fish}
            </span>
          ))}
        </div>
      </section>
    )}

  </div>
</BaseLayout>
