---
import BaseLayout from '../../layouts/BaseLayout.astro';
import LureCard from '../../components/LureCard.astro';
import { fetchAllLures } from '../../lib/fetch-all-lures';
import { groupLuresBySeries } from '../../lib/group-lures';
import type { LureSeries } from '../../lib/types';

export async function getStaticPaths() {
  const lures = await fetchAllLures();

  const allSeries = groupLuresBySeries(lures ?? []);

  // メーカースラグでグルーピング
  const manufacturerMap = new Map<string, { manufacturer: string; series: LureSeries[] }>();
  for (const s of allSeries) {
    const existing = manufacturerMap.get(s.manufacturer_slug);
    if (existing) {
      existing.series.push(s);
    } else {
      manufacturerMap.set(s.manufacturer_slug, {
        manufacturer: s.manufacturer,
        series: [s],
      });
    }
  }

  return [...manufacturerMap.entries()].map(([slug, data]) => ({
    params: { manufacturer_slug: slug },
    props: { manufacturer: data.manufacturer, series: data.series },
  }));
}

const { manufacturer, series } = Astro.props as {
  manufacturer: string;
  series: LureSeries[];
};

const manufacturerSlug = Astro.params.manufacturer_slug;

// JSON-LD: ItemList schema for manufacturer page
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: `${manufacturer}のルアー一覧`,
  url: `https://www.lure-db.com/${manufacturerSlug}/`,
  description: `${manufacturer}のルアー ${series.length}シリーズを掲載。カラーバリエーション・スペック・価格情報を網羅。`,
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: series.length,
    itemListElement: series.slice(0, 50).map((s, i) => ({
      '@type': 'ListItem',
      position: i + 1,
      url: `https://www.lure-db.com/${s.manufacturer_slug}/${s.slug}/`,
      name: s.name,
    })),
  },
};
---

<BaseLayout title={`${manufacturer}のルアー一覧 - Lure DB`} description={`${manufacturer}のルアー ${series.length}シリーズを掲載。カラーバリエーション・スペック・価格情報を網羅。`} canonicalPath={`/${manufacturerSlug}/`} jsonLd={jsonLd}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- パンくず -->
    <nav class="text-sm text-text-secondary mb-8">
      <a href="/" class="hover:text-primary transition-colors">トップ</a>
      <span class="mx-2">/</span>
      <span class="text-gray-900">{manufacturer}</span>
    </nav>

    <div class="mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">{manufacturer}</h1>
      <p class="text-sm text-text-secondary mt-1">
        {series.length}シリーズ
      </p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
      {series.map(s => (
        <LureCard series={s} isNew={false} />
      ))}
    </div>

  </div>
</BaseLayout>
