# タスク: URL構造・表示グルーピング改修

## 方針
- 既存データは全削除（TRUNCATE）してから新スキーマを適用する
- Supabase DBへ直接マイグレーション実行してOK
- slugの英語変換マッピングは不要（データリセットするため）

## 作業内容

### 1. DBスキーマ変更（Supabase直接実行）

luresテーブルに以下を実行:

```sql
-- 既存データ全削除
TRUNCATE TABLE public.lures;

-- 新カラム追加
ALTER TABLE public.lures
  ADD COLUMN IF NOT EXISTS slug TEXT,
  ADD COLUMN IF NOT EXISTS manufacturer_slug TEXT;

-- NOT NULL制約（データ入れる前に設定）
-- slugとmanufacturer_slugは必須にする
ALTER TABLE public.lures
  ALTER COLUMN slug SET NOT NULL,
  ALTER COLUMN manufacturer_slug SET NOT NULL;

-- インデックス追加
CREATE INDEX IF NOT EXISTS idx_lures_slug ON public.lures(slug);
CREATE INDEX IF NOT EXISTS idx_lures_manufacturer_slug ON public.lures(manufacturer_slug);
```

**注意**: Supabase JS Clientの anon key では DDL実行できない可能性がある。
その場合は `supabase-schema.sql` を更新し、migration SQLファイル (`migration-001-add-slugs.sql`) を作成すること。
ファイルだけ作って「Supabaseダッシュボードで実行してください」とコメントを残すこと。

### 2. TypeScript型定義の更新

`src/lib/supabase.ts` の `Lure` 型に追加:
```typescript
slug: string
manufacturer_slug: string
```

`src/lib/types.ts` の `LureSeries` 型に追加:
```typescript
manufacturer_slug: string
```

### 3. URL構造の変更

**現在**: `/lure/[slug]`（slugはclient-side生成、日本語はencodeURIComponent）
**変更後**: `/[manufacturer_slug]/[slug]/`（DB格納の英語slug使用）

#### ファイル変更:
- `src/pages/lure/[slug].astro` → 削除
- `src/pages/[manufacturer_slug]/[slug].astro` → 新規作成
- `src/pages/[manufacturer_slug]/index.astro` → 新規作成（メーカー別一覧）

#### [manufacturer_slug]/[slug].astro:
- `getStaticPaths()` でSupabaseから全luresを取得
- `groupLuresBySeries()` でシリーズにまとめる
- params: `{ manufacturer_slug: series.manufacturer_slug, slug: series.slug }`
- 詳細ページの内容は現在の `lure/[slug].astro` と同じ

#### [manufacturer_slug]/index.astro:
- そのメーカーのルアーシリーズ一覧を表示
- LureCardコンポーネントを再利用

### 4. group-lures.ts の更新

`groupLuresBySeries()` を修正:
- `slug` はDBから取得した値を使う（client-side生成をやめる）
- `manufacturer_slug` をLureSeriesに含める
- カラーのグルーピングロジックを変更:
  - **現在**: `color_name|weight` で重複排除 → 各色×重さが個別カード
  - **変更後**: `color_name` でグルーピング → 同じカラー名の異なるウェイトは1つにまとめる

`ColorVariant` 型を修正:
```typescript
export type ColorVariant = {
  color_name: string;
  color_description: string | null;
  weights: { weight: number | null; length: number | null; price: number }[];  // ウェイト違いをここにまとめる
  images: string[] | null;
  is_limited: boolean;
  is_discontinued: boolean;
};
```

### 5. 詳細ページのカラーバリエーション表示変更

現在: 各色が個別カードで表示
変更後:
- 各カラーカード内にウェイトバッジを横並びで表示
- 例: カラー名「GGメガバスレッド」のカード内に「7g | 10g | 14g」のようなバッジ

```astro
{series.colors.map(color => (
  <div class="group">
    <!-- 画像 -->
    <div class="aspect-square rounded-xl overflow-hidden border border-gray-100 bg-white mb-2">
      {color.images && color.images.length > 0 ? (
        <img src={color.images[0]} alt={color.color_name} loading="lazy" class="w-full h-full object-scale-down p-3" />
      ) : (
        <Placeholder size="sm" />
      )}
    </div>
    <!-- カラー名 -->
    <p class="text-sm font-medium text-gray-900 truncate">{color.color_name}</p>
    <!-- ウェイトバッジ横並び -->
    {color.weights.length > 0 && (
      <div class="flex flex-wrap gap-1 mt-1">
        {color.weights.map(w => (
          <span class="px-2 py-0.5 bg-gray-50 text-xs text-gray-600 rounded-full border border-gray-100">
            {w.weight && `${w.weight}g`}{w.weight && w.length && ' / '}{w.length && `${w.length}mm`}
          </span>
        ))}
      </div>
    )}
    <!-- バッジ -->
    <div class="flex items-center gap-2 mt-0.5">
      {color.is_limited && <Badge label="限定" variant="limited" />}
      {color.is_discontinued && <Badge label="廃盤" variant="discontinued" />}
    </div>
  </div>
))}
```

### 6. LureCard.astro の更新

- リンク先を `/lure/${series.slug}` → `/${series.manufacturer_slug}/${series.slug}` に変更
- filterDataに `manufacturer_slug` を追加

### 7. slugify.ts の更新

DBにslugが格納されるようになったので、client-side slugify は補助的な役割に。
ただし、データ投入時の参考用に残しておく。

### 8. パンくずリストの更新

詳細ページのパンくず:
```
トップ / {manufacturer名} / {series.name}
```
トップ → `/`
manufacturer名 → `/{manufacturer_slug}/`

### 9. supabase-schema.sql の更新

新しいスキーマ定義に `slug` と `manufacturer_slug` カラムを追加。
sample-data.sql も新カラムを含むように更新。

### 10. ビルド確認

最後に `npm run build` を実行してビルドが通ることを確認。
データが空なので0ページ生成でOK。エラーがなければ成功。

## 注意事項
- Tailwind CSS v4 を使用中（@tailwindcss/vite）。className記法はそのまま。
- 既存のコンポーネント（Badge, Placeholder, FilterBar, Header, Footer）は極力そのまま活用。
- `BaseLayout` の構造は変えない。
- git commitはしないこと。変更を加えるだけ。
